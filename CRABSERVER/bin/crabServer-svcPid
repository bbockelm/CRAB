#!/usr/bin/env python
"""
crabServer-svcPid

get pid of selected service

"""

import os, re, sys
import getopt

def usage():

    usage = \
    """
    Usage: crabServer-svcPid --service=<srvc> 
          
    """
    print usage

# # # #

valid = ['service=']

try:
    opts, args = getopt.getopt(sys.argv[1:], "", valid)
except getopt.GetoptError, ex:
    print str(ex)
    usage()
    sys.exit(1)

def getPIDof(procname):
    if procname == 'mysqld':
        pids = os.popen("ps -C %s wwho pid"%procname).read()
        if re.match('\s*[0-9]+\s*',str(pids)):
            pid = str(pids).split()[0]
            return pid.rstrip()
        else:
            return "Not Running"
    else:
        pids = os.popen("ps -C %s wwho pgid,pid"%procname).readlines()
        for ipid in pids:
            if re.match('\s*[0-9]+\s*[0-9]+\s*',str(ipid)):
                pgid, pid = str(ipid).split()[0:2]
                if pid == pgid:
                    return pid.rstrip()
        return "Not Running"

service = None

for opt, arg in opts:
    if opt == "--service":
        service = arg

AllServices = {'GridFTP':'globus-gridftp-server','mySQL':'mysqld'}

if service in AllServices.keys():
    print "%s" %str(getPIDof(AllServices[service]))
else:
    sys.exit(1)

