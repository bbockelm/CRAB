#! /bin/sh
#
# Stefano Lacaprara  <lacaprara@pd.infn.it>  INFN Padova
#
# Installation script for Crab
#
# 09-March-2006

# Subdir structure:
# top/
#     python/...
#     DBSAPI
#     DLSAPI
#     ProdCommon
#     sqlite
#     py2-pysqlite       
#
TopDir=`\pwd`
sqlite_ver=3.4.0
pysql_ver=2.4.0

SQLITE_ROOT=$TopDir/sqlite/
PYSQLITE_ROOT=$TopDir/pysqlite/

function configureSqlite {
# part for Sqlite install
echo " SQLITE Installation: begin at `date`"
cd $TopDir/sqlite
echo "untar.. "
tar zxvf sqlite-$sqlite_ver.tar.gz > /dev/null 2>&1 
cd sqlite-$sqlite_ver
mkdir .libs
ln -s /usr/lib/libreadline.so.4.3 .libs/libreadline.so
echo "configure... "
./configure --prefix=$SQLITE_ROOT --disable-tcl >/dev/null 2>&1
echo "compile and install.... "
make >/dev/null 2>&1
make install >/dev/null 2>&1
cd ../..
echo "SQLITE Installation: end at `date`"
return
}
function configurePysqlite {
# part for Py2-pysqlite install
echo "Py2-pysqlite Installation: begin at `date`"
cd $TopDir/py2-pysqlite
echo "untar.. "
tar zxvf pysqlite-$pysql_ver.tar.gz  >/dev/null 2>&1
cd pysqlite-$pysql_ver
perl -p -i -e "s!include_dirs=.*!include_dirs=$SQLITE_ROOT/include!" setup.cfg
perl -p -i -e "s!library_dirs=.*!library_dirs=$SQLITE_ROOT/lib!" setup.cfg
echo "build and install... "
python setup.py build  >/dev/null 2>&1
python setup.py install --prefix=$PYSQLITE_ROOT  >/dev/null 2>&1
cd ../..
echo "Py2-pysqlite  Installation: end at `date`"
return
}

function configureCrab {
## prapare the crab env
cd $TopDir
tar zxvf sqlite.tgz > /dev/null 2>&1
rm sqlite.tgz
tar zxvf py2-pysqlite.tgz > /dev/null 2>&1
rm py2-pysqlite.tgz

# sh style
cat > crab.sh <<EOF
#! /bin/sh
# CRAB related Stuff
export CRABDIR=$TopDir

CRABPATH=\${CRABDIR}/python
CRABDLSAPIPATH=\${CRABDIR}/DLSAPI
export CRABPYTHON=\${CRABDIR}/python
export CRABDBSAPIPYTHON=\${CRABDIR}/DBSAPI
export CRABDLSAPIPYTHON=\${CRABDIR}/DLSAPI
export CRABPSETPYTHON=\${CRABDIR}/PsetCode
export CRABPRODAGENTPYTHON=\${CRABDIR}/ProdAgentApi
export CRABPRODCOMMONPYTHON=\${CRABDIR}/ProdCommon


if [ -z "\$PATH" ]; then
export PATH=\${CRABPATH}
else
export PATH=\${CRABPATH}:\${PATH}
fi
if [ -z "\$PYTHONPATH" ]; then
export PYTHONPATH=\${CRABPYTHON}:\${CRABDBSAPIPYTHON}:\${CRABDLSAPIPYTHON}:\${CRABPSETPYTHON}:\${CRABPRODAGENTPYTHON}:\${CRABPRODCOMMONPYTHON}
else
export PYTHONPATH=\${PYTHONPATH}:\${CRABPYTHON}:\${CRABDBSAPIPYTHON}:\${CRABDLSAPIPYTHON}:\${CRABPSETPYTHON}:\${CRABPRODAGENTPYTHON}:\${CRABPRODCOMMONPYTHON}
fi


## sqlite
export CRABSQLITE=\${CRABDIR}/sqlite/
export CRABSQLITE_VERSION="3.3.5"
export CRABSQLITE_ROOT=\$CRABSQLITE/\$CRABSQLITE_VERSION

export PATH=\${CRABSQLITE_ROOT}/bin:\${PATH}
export LD_LIBRARY_PATH=\${CRABSQLITE_ROOT}/lib:\${LD_LIBRARY_PATH}


## py2sql
export CRABPYSQLITE=\${CRABDIR}/py2-pysqlite
export CRABPY2_PYSQLITE_VERSION="2.3.2"
export CRABPY2_PYSQLITE_REVISION="1008"
export CRABPY2_PYSQLITE_ROOT=\$CRABPYSQLITE/\$CRABPY2_PYSQLITE_VERSION

export LD_LIBRARY_PATH=\$CRABPY2_PYSQLITE_ROOT/lib:\$LD_LIBRARY_PATH

export PYTHON_VERSION=2.3.4 
export PYTHONPATH=\${CRABPY2_PYSQLITE_ROOT}/lib/python2.4/site-packages:\$PYTHONPATH
## partially hardcoded path for python version "2.4"
## need to do something like:
#export PYTHONPATH=\${CRABPY2_PYSQLITE_ROOT}/lib/python`echo $PYTHON_VERSION | cut -f1,2 -d.`/site-packages:\${PYTHONPATH}


EOF

# csh style
cat > crab.csh <<EOF
#! /bin/csh
# CRAB related Stuff
setenv CRABDIR $TopDir

set CRABPATH=\${CRABDIR}/python
set CRABDLSAPIPATH=\${CRABDIR}/DLSAPI
setenv CRABPYTHON \${CRABDIR}/python
setenv CRABDBSAPIPYTHON \${CRABDIR}/DBSAPI
setenv CRABDLSAPIPYTHON \${CRABDIR}/DLSAPI
setenv CRABPRODCOMMONPYTHON \${CRABDIR}/ProdCommon


if ( ! \$?path ) then
set path=(\${CRABPATH})
else
set path=( \${CRABPATH} \${path})
endif
if ( ! \$?PYTHONPATH ) then
setenv PYTHONPATH \${CRABPYTHON}:\${CRABDBSAPIPYTHON}:\${CRABDLSAPIPYTHON}:\${CRABPRODCOMMONPYTHON}
else
setenv PYTHONPATH \${PYTHONPATH}:\${CRABPYTHON}:\${CRABDBSAPIPYTHON}:\${CRABDLSAPIPYTHON}:\${CRABPRODCOMMONPYTHON}
endif


## sqlite
setenv CRABSQLITE \${CRABDIR}/sqlite/
setenv CRABSQLITE_VERSION "3.3.5"
setenv CRABSQLITE_ROOT \$CRABSQLITE/\$CRABSQLITE_VERSION

setenv PATH \${CRABSQLITE_ROOT}/bin:\${PATH}
setenv LD_LIBRARY_PATH \${CRABSQLITE_ROOT}/lib:\${LD_LIBRARY_PATH}


## py2sql
setenv CRABPYSQLITE \${CRABDIR}/py2-pysqlite
setenv CRABPY2_PYSQLITE_VERSION "2.3.2"
setenv CRABPY2_PYSQLITE_REVISION "1008"
setenv CRABPY2_PYSQLITE_ROOT \$CRABPYSQLITE/\$CRABPY2_PYSQLITE_VERSION

setenv LD_LIBRARY_PATH \$CRABPY2_PYSQLITE_ROOT/lib:\$LD_LIBRARY_PATH

setenv PYTHON_VERSION 2.3.4 
setenv PYTHONPATH \${CRABPY2_PYSQLITE_ROOT}/lib/python2.4/site-packages:\$PYTHONPATH
## partially hardcoded path for python version "2.4"
## need to do something like:
#setenv PYTHONPATH \${CRABPY2_PYSQLITE_ROOT}/lib/python`echo $PYTHON_VERSION | cut -f1,2 -d.`/site-packages:\${PYTHONPATH}


EOF
return
}

#configureSqlite 
#configurePysqlite 
configureCrab

