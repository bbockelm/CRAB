#! /bin/sh
#
# Stefano Lacaprara  <lacaprara@pd.infn.it>  INFN Padova
#
# Installation script for Crab
#
# 09-March-2006

# Subdir structure:
# top/
#     python/...
#     DBSAPI
#     DLSAPI
#     ProdCommon
#     sqlite
#     py2-pysqlite       
#
TopDir=`\pwd`
ExtDir=$TopDir/external
sqlite_ver=3.4.0
pysql_ver=2.4.0

SQLITE_ROOT=$TopDir/sqlite/
PYSQLITE_ROOT=$TopDir/pysqlite/

function configureCrab {
## prapare the crab env
cd $ExtDir

## TEMPORARY HACK
tar zxvf crablib.tgz > /dev/null 2>&1
rm crablib.tgz

tar zxvf sqlite.tgz > /dev/null 2>&1
rm sqlite.tgz

tar zxvf py2-pysqlite.tgz > /dev/null 2>&1
rm py2-pysqlite.tgz

tar zxvf pyOpenSSL-0.6-python2.4.tar.gz  > /dev/null 2>&1
rm pyOpenSSL-0.6-python2.4.tar.gz > /dev/null 2>&1

tar zxvf simplejson.tgz > /dev/null 2>&1
rm simplejson.tgz 

tar zxvf pbs_python.tgz > /dev/null 2>&1
rm pbs_python.tgz

## go to $TopDir
cd ..

# sh style
cat > crab.sh <<EOF
#! /bin/sh
# first check if CRAB env has already been defined
[ ! -z "\$CRABDIR" ] && ( echo 'CRAB environment already defined: exiting' ; exit 1 ; )

# CRAB related Stuff
export CRABDIR=$TopDir
export EXTERNALDIR=$ExtDir

CRABPATH=\${CRABDIR}/python
CRABDLSAPIPATH=\${EXTERNALDIR}/DLSAPI/bin
export CRABPYTHON=\${CRABDIR}/python
export CRABDBSAPIPYTHON=\${EXTERNALDIR}/DBSAPI
export CRABDLSAPIPYTHON=\${EXTERNALDIR}/DLSAPI/lib
export CRABPRODCOMMONPYTHON=\${EXTERNALDIR}


if [ -z "\$PATH" ]; then
export PATH=\${CRABPATH}:\${CRABDLSAPIPATH}
else
export PATH=\${CRABPATH}:\${CRABDLSAPIPATH}:\${PATH}
fi
if [ -z "\$PYTHONPATH" ]; then
export PYTHONPATH=\${CRABPYTHON}:\${CRABDBSAPIPYTHON}:\${CRABDLSAPIPYTHON}:\${CRABPRODCOMMONPYTHON}
else
export PYTHONPATH=\${PYTHONPATH}:\${CRABPYTHON}:\${CRABDBSAPIPYTHON}:\${CRABDLSAPIPYTHON}:\${CRABPRODCOMMONPYTHON}
fi


## sqlite
export CRABSQLITE=\${EXTERNALDIR}/sqlite/
export CRABSQLITE_VERSION="3.3.5"
export CRABSQLITE_ROOT=\$CRABSQLITE/\$CRABSQLITE_VERSION

export PATH=\${CRABSQLITE_ROOT}/bin:\${PATH}
export LD_LIBRARY_PATH=\${LD_LIBRARY_PATH}:\${CRABSQLITE_ROOT}/lib


## py2sql
export CRABPYSQLITE=\${EXTERNALDIR}/py2-pysqlite
export CRABPY2_PYSQLITE_VERSION="2.3.2"
export CRABPY2_PYSQLITE_REVISION="1008"
export CRABPY2_PYSQLITE_ROOT=\$CRABPYSQLITE/\$CRABPY2_PYSQLITE_VERSION

export LD_LIBRARY_PATH=\$CRABPY2_PYSQLITE_ROOT/lib:\$EXTERNALDIR/crablib:\$LD_LIBRARY_PATH

export PYTHON_VERSION=2.3.4 
export PYTHONPATH=\${CRABPY2_PYSQLITE_ROOT}/lib/python2.4/site-packages:\$PYTHONPATH
## partially hardcoded path for python version "2.4"
## need to do something like:
#export PYTHONPATH=\${CRABPY2_PYSQLITE_ROOT}/lib/python`echo $PYTHON_VERSION | cut -f1,2 -d.`/site-packages:\${PYTHONPATH}

## simplejson
export CRABSIMPLEJSON=\${EXTERNALDIR}/simplejson 
export CRAB_SIMPLEJSON_VERSION="2.0.9"
export CRAB_SIMPLEJSON_ROOT=\$CRABSIMPLEJSON/\$CRAB_SIMPLEJSON_VERSION

export PYTHONPATH=\${CRAB_SIMPLEJSON_ROOT}/lib/python2.4/site-packages:\$PYTHONPATH

## pyOpenssl
export PyOpenSSLPYTHON=\${EXTERNALDIR}
export PYTHONPATH=\${PYTHONPATH}:\${PyOpenSSLPYTHON}

## pbs_python
export CRABPBSPYTHON=\${EXTERNALDIR}/pbs_python
export CRAB_PBSPYTHON_VERSION="3.2.0"
export CRAB_PBSPYTHON_ROOT=\${CRABPBSPYTHON}/\${CRAB_PBSPYTHON_VERSION}

export PYTHONPATH=\${CRAB_PBSPYTHON_ROOT}/lib/python2.4/site-packages/pbs:\$PYTHONPATH


EOF

# csh style
cat > crab.csh <<EOF
#! /bin/csh
# first check if CRAB env has already been defined
if ( \$?CRABDIR ) then
   echo 'CRAB environment already defined: exiting' 
   exit 1
endif
# CRAB related Stuff
setenv CRABDIR $TopDir
setenv EXTERNALDIR $ExtDir

set CRABPATH=\${CRABDIR}/python
set CRABDLSAPIPATH=\${EXTERNALDIR}/DLSAPI/bin
setenv CRABPYTHON \${CRABDIR}/python
setenv CRABDBSAPIPYTHON \${EXTERNALDIR}/DBSAPI
setenv CRABDLSAPIPYTHON \${EXTERNALDIR}/DLSAPI/lib
setenv CRABPRODCOMMONPYTHON \${EXTERNALDIR}


if ( ! \$?path ) then
set path=(\${CRABPATH})
else
set path=( \${CRABPATH} \${path})
endif
if ( ! \$?PYTHONPATH ) then
setenv PYTHONPATH \${CRABPYTHON}:\${CRABDBSAPIPYTHON}:\${CRABDLSAPIPYTHON}:\${CRABPRODCOMMONPYTHON}
else
setenv PYTHONPATH \${PYTHONPATH}:\${CRABPYTHON}:\${CRABDBSAPIPYTHON}:\${CRABDLSAPIPYTHON}:\${CRABPRODCOMMONPYTHON}
endif


## sqlite
setenv CRABSQLITE \${EXTERNALDIR}/sqlite/
setenv CRABSQLITE_VERSION "3.3.5"
setenv CRABSQLITE_ROOT \$CRABSQLITE/\$CRABSQLITE_VERSION

setenv PATH \${CRABSQLITE_ROOT}/bin:\${PATH}
setenv LD_LIBRARY_PATH \${LD_LIBRARY_PATH}:\${CRABSQLITE_ROOT}/lib:\$EXTERNALDIR/crablib


## py2sql
setenv CRABPYSQLITE \${EXTERNALDIR}/py2-pysqlite
setenv CRABPY2_PYSQLITE_VERSION "2.3.2"
setenv CRABPY2_PYSQLITE_REVISION "1008"
setenv CRABPY2_PYSQLITE_ROOT \$CRABPYSQLITE/\$CRABPY2_PYSQLITE_VERSION

setenv LD_LIBRARY_PATH \$CRABPY2_PYSQLITE_ROOT/lib:\$LD_LIBRARY_PATH

setenv PYTHON_VERSION 2.3.4 
setenv PYTHONPATH \${CRABPY2_PYSQLITE_ROOT}/lib/python2.4/site-packages:\$PYTHONPATH
## partially hardcoded path for python version "2.4"
## need to do something like:
#setenv PYTHONPATH \${CRABPY2_PYSQLITE_ROOT}/lib/python`echo $PYTHON_VERSION | cut -f1,2 -d.`/site-packages:\${PYTHONPATH}

## simplejson
setenv CRABSIMPLEJSON \${EXTERNALDIR}/simplejson 
setenv CRAB_SIMPLEJSON_VERSION "2.0.9"
setenv CRAB_SIMPLEJSON_ROOT \$CRABSIMPLEJSON/\$CRAB_SIMPLEJSON_VERSION

setenv PYTHONPATH \${CRAB_SIMPLEJSON_ROOT}/lib/python2.4/site-packages:\$PYTHONPATH

## pyOpenssl
setenv PyOpenSSLPYTHON \${EXTERNALDIR}
setenv PYTHONPATH \${PYTHONPATH}:\${PyOpenSSLPYTHON}

## pbs_python
setenv CRABPBSPYTHON \${EXTERNALDIR}/pbs_python
setenv CRAB_PBSPYTHON_VERSION "3.2.0"
setenv CRAB_PBSPYTHON_ROOT \${CRABPBSPYTHON}/\${CRAB_PBSPYTHON_VERSION}

setenv PYTHONPATH \${CRAB_PBSPYTHON_ROOT}/lib/python2.4/site-packages/pbs:\$PYTHONPATH


EOF
return
}

echo
echo -n Configuring CRAB..... 
configureCrab
echo "Done"
echo
